# ============================================================================
# Plasten Project - Geometry Layers Configuration
# ============================================================================
# 
# This file defines the layer processing pipeline for the Plasten AgriPV project.
# 
# Key Concepts:
# - Geltungsbereich: Legal planning boundary (follows AgriPV outline)
# - AgriPV: Solar planning designation zone
# - Baugrenze: Construction boundary (where panels actually go)
# - Dead Zones: AgriPV areas excluded from Baugrenze due to buffers
#
# Processing Flow:
# 1. Load input shapefiles
# 2. Define boundaries (Flur, Gemarkung, Gemeinde, Parcel)
# 3. Calculate Hard Exclusions (Wald, Biotopes)
# 4. Calculate Soft Exclusions (utilities, buildings, roads, trees)
# 5. Calculate Geltungsbereich Base from parcels
# 6. Calculate AgriPV (expands 20m into soft exclusions)
# 7. Final Geltungsbereich (follows AgriPV outline)
# 8. Calculate Baugrenze (20m inset from AgriPV, minus buffer zones)
# 9. Apply hatching/styling
# 10. Generate infrastructure layers
#
# ============================================================================

geomLayers:

  # ==========================================================================
  # SECTION 1: INPUT SHAPEFILES - Raw data sources
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Administrative Boundaries
  # --------------------------------------------------------------------------

  - name: Nutzungsartengrenze
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/nutzungsartengrenze5_pl.shp"
    close: true
    # sync: push

  - name: Acker Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Acker.shp"
    close: true

  - name: Acker
    operations:
      - type: dissolve
        layers:
          - Acker Input

  - name: Acker_S Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Acker_S.shp"
    close: true

  - name: Acker_S
    operations:
      - type: dissolve
        layers:
          - Acker_S Input

  # Input polygon layers (kept for filtering operations like filterByIntersection)
  - name: Flur Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/flur.shp"
    label: flurname
    viewports:
      - name: WorkView
        style: flurWorkView

  - name: Gemarkung Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/gemarkung.shp"
    label: gmkname
    viewports:
      - name: WorkView
        style: gemarkungWorkView

  - name: Gemeinde Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/gemeinde.shp"
    label: gen
    viewports:
      - name: WorkView
        style: gemeindeWorkView

  # Reconstructed Gemeinde (high-detail boundaries from Gemarkung polygons)
  # Uses dissolveByMajorityIntersection to rebuild accurate Gemeinde boundaries
  # from higher-resolution Gemarkung data, eliminating topological inconsistencies.
  - name: Gemeinde Reconstructed
    label: gen
    operations:
      - type: dissolveByMajorityIntersection
        sourceLayer: Gemarkung Input
        referenceLayer: Gemeinde Input
        transferAttributes:
          - gen
        threshold: 50.0

  # Output boundary layers (cleaned, duplicate-free, for AutoCAD export)
  - name: Flur
    label: flurname
    close: false
    linetypeScale: 0.2
    linetypeGeneration: true
    style: flurgrenze
    sync: push
    viewports:
      - name: WorkView
        style: flurWorkView
    operations:
      - type: extractBoundary
        layers:
          - Flur Input
      - type: breakAtIntersections
        tolerance: 0.001
      - type: removeDuplicateLines
        tolerance: 0.01
      - type: simpleLabel
        layers:
          - Flur Input

  - name: Gemarkung
    label: gmkname
    close: false
    linetypeGeneration: true
    style: gemarkungsgrenze
    sync: push
    viewports:
      - name: WorkView
        style: gemarkungWorkView
    operations:
      - type: extractBoundary
        layers:
          - Gemarkung Input
      - type: breakAtIntersections
        tolerance: 0.001
      - type: removeDuplicateLines
        tolerance: 0.01
      - type: simpleLabel
        layers:
          - Gemarkung Input

  - name: Gemeinde
    label: gen
    close: false
    linetypeGeneration: true
    style: gemeindegrenze
    sync: push
    viewports:
      - name: WorkView
        style: gemeindeWorkView
    operations:
      - type: extractBoundary
        layers:
          - Gemeinde Reconstructed
      - type: breakAtIntersections
        tolerance: 0.001
      - type: removeDuplicateLines
        tolerance: 0.01
      - type: simpleLabel
        layers:
          - Gemeinde Reconstructed

  - name: Parcel
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/parcel.shp"
    label: label
    close: true
    style: parcel
    viewports:
      - name: WorkView
        style: parcelWorkView

  # --------------------------------------------------------------------------
  # Hard Exclusions - Features that exclude BOTH AgriPV and Baugrenze
  # --------------------------------------------------------------------------

  - name: Wald
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/wald.shp"
    close: true
    sync: push
    viewports:
      - name: WorkView
        style: waldWorkView
    operations:
      - type: dissolve
      # Subtract land use areas (keep only Wald outside agricultural zones)
      - type: difference
        layers:
          - Acker
          - Acker_S
          - Nutzungsartengrenze
        reverseDifference: false

  - name: Moor
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Moor.shp"
    close: true
    sync: push
    style:
      layer:
        plot: false
    operations:
      - type: dissolve

  - name: Biotope Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/biotope.shp"

  - name: Geschütze Biotope
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/gesch_biotope.shp"
    style:
      layer:
        plot: false

  # Combined biotope layer (both types merged)
  - name: Biotope
    style:
      layer:
        plot: false
    viewports:
      - name: WorkView
        style: biotopWorkView
    operations:
      - type: dissolve
        layers:
          - Biotope Input
          - Geschütze Biotope

  # --------------------------------------------------------------------------
  # Soft Exclusion Inputs - Features that only exclude Baugrenze (not AgriPV)
  # --------------------------------------------------------------------------

  - name: Einzelbaumlinie
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/baum_abstand.shp"

  - name: Straßenflurstückskante
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/straßenflürstückskante.shp"

  - name: FG_Unterirdisch
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/FG_Unterirdisch.shp"
    sync: push
    operations:
      - type: cleanLine
        tolerance: 0.01
        minSegmentLength: 0.5

  # Raw input containing complete FG data (both oberirdisch and unterirdisch)
  - name: FG_Oberirdisch Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/FG_Oberirdisch.shp"

  # Buffer mask to subtract underground sections from complete FG
  - name: FG_Unterirdisch Buffer Mask
    operations:
      - type: buffer
        layers:
          - FG_Unterirdisch
        distance: 1
        capStyle: flat  # Critical: no extension beyond line endpoints
        joinStyle: round
        quadSegs: 16

  # Corrected oberirdisch layer: complete FG minus underground sections
  - name: FG_Oberirdisch
    sync: push
    operations:
      - type: copy
        layers:
          - FG_Oberirdisch Input
      - type: difference
        layers:
          - FG_Unterirdisch Buffer Mask
        reverseDifference: false
      - type: cleanLine
        tolerance: 0.01
        minSegmentLength: 0.5

  - name: Ontras_FG_buffer_4
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Ontras_FG_buffer_4.shp"
    style:
      layer:
        color: "orange"
        plot: false

  - name: Ontras_FG_buffer_2
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Ontras_FG_buffer_2.shp"
    style:
      layer:
        color: "orange"
        plot: false

  - name: Mittelspannungsleitung Input
    dxfSource:
      file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20250827_Klein Plasten Süd - Rockower Str.dxf"
      layer: "01 Mittelspannungsleitung"
      entityTypes:
        - LINE
        - LWPOLYLINE
        - POLYLINE

  - name: Mittelspannungsleitung
    sync: push
    operations:
      - type: copy
        layers:
          - Mittelspannungsleitung Input
      - type: cleanLine
        tolerance: 0.01
        minSegmentLength: 0.5

  - name: Gebäude 150m Abstand
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/gebäude_150m_abstand.shp"

  - name: Gebäude
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Gebäude.shp"
    sync: push

  - name: Böschung
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Böschung.shp"
    close: true

  # --------------------------------------------------------------------------
  # Manual Exclusions
  # --------------------------------------------------------------------------

  # - name: Exclude Baufeld
  #   shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Exclude Baufeld.shp"

  - name: Exclude Baugrenze
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Exclude Baugrenze.shp"

  - name: Exclude Geltungsbereich
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Exclude Geltungsbereich.shp"

  # --------------------------------------------------------------------------
  # Manual Inclusions
  # --------------------------------------------------------------------------

  - name: Include AgriPV
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Include AgriPV.shp"
    close: true

  - name: Include Geltungsbereich
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Include Geltungsbereich.shp"
    close: true
    operations:
      - type: dissolve

  # --------------------------------------------------------------------------
  # Infrastructure Inputs
  # --------------------------------------------------------------------------

  - name: Blendschutzzaun Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/blendschutzzaun.shp"

  - name: Einfahrt Line Reference
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/einfahrt_line.shp"

  - name: EinAusfahrt Line Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/einausfahrt_line.shp"

  - name: Wege Input
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Wege.shp"

  - name: Zuwegung
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/Zuwegung.shp"
    sync: push
    close: true
    operations:
      # Subtract manual exclusions from Zuwegung
      - type: difference
        layers:
          - Exclude Geltungsbereich
        reverseDifference: false

  # --------------------------------------------------------------------------
  # Böschung (Slope) Layers from External DXF - GPS Survey Lines
  # --------------------------------------------------------------------------
  # These layers contain GPS survey lines that sometimes have gaps.
  # First, we load both layers separately, then merge them into a single layer,
  # and finally apply polygonize to automatically connect closest endpoints
  # to create closed polygons from the line segments.

  # - name: T--Böschung_eindeut_OK Source
  #   dxfSource:
  #     file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Entwurfsvermessung/6 - Devener Weg/Groß Plasten II (Dewener Weg)/PV Groß Plasten II_Entwurfsvermessung_2025-07-29_VB-Haff_edit.dxf"
  #     layer: "T--Böschung_eindeut_OK"
  #     entityTypes:
  #       - LINE
  #       - LWPOLYLINE
  #       - POLYLINE

  # - name: T--Böschung_eindeut_UK Source
  #   dxfSource:
  #     file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Entwurfsvermessung/6 - Devener Weg/Groß Plasten II (Dewener Weg)/PV Groß Plasten II_Entwurfsvermessung_2025-07-29_VB-Haff_edit.dxf"
  #     layer: "T--Böschung_eindeut_UK"
  #     entityTypes:
  #       - LINE
  #       - LWPOLYLINE
  #       - POLYLINE

  # # Combined Böschung layer (polygonized from both OK + UK sources)
  # # Note: polygonize operation collects lines from multiple source layers directly
  # # without merging them first, preserving individual line segments for proper gap closing
  # - name: T--Böschung_eindeut
  #   operations:
  #     - type: polygonize
  #       layers:
  #         - T--Böschung_eindeut_OK Source
  #         - T--Böschung_eindeut_UK Source
  #       # maxPolygons: 2  # Keep only the 2 largest polygons (outer boundaries)
  #     - type: dissolve

  # --------------------------------------------------------------------------
  # PV Module Blocks from External DXF
  # --------------------------------------------------------------------------

  # # Individual PV module sources (loaded separately, then merged)
  # - name: PV Modules I Source
  #   dxfSource:
  #     file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20251021_Groß Plasten I - Am Spargelberg 9m_bereinigt.dxf"
  #     layer: "PVcase PV Modules (full frames)"
  #     preprocessors:
  #       # Explode blocks and extract only the module boundary (POLYLINE on optimised layer)
  #       # This skips the individual panel 3DSOLIDs which we don't need for planning
  #       - name: block_exploder
  #         target_layer: "PVcase PV Modules (optimised)"
  #     entityTypes:
  #       - LWPOLYLINE
  #       - POLYLINE

  # - name: PV Modules II Source
  #   dxfSource:
  #     file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20251021_Groß Plasten II - Devener Weg_bereinigt.dxf"
  #     layer: "PVcase PV Modules (full frames)"
  #     preprocessors:
  #       - name: block_exploder
  #         target_layer: "PVcase PV Modules (optimised)"
  #     entityTypes:
  #       - LWPOLYLINE
  #       - POLYLINE

  # - name: PV Modules Süd Source
  #   dxfSource:
  #     file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20250827_Klein Plasten Süd - Rockower Str.dxf"
  #     layer: "PVcase PV Modules (full frames)"
  #     preprocessors:
  #       - name: block_exploder
  #         target_layer: "PVcase PV Modules (optimised)"
  #     entityTypes:
  #       - LWPOLYLINE
  #       - POLYLINE

  # # Combined PV Modules layer
  # # TEMPORARY: Using sync:pull to retrieve manually corrected geometry from AutoCAD
  # # The upstream DXF sources had modules extending beyond Baugrenze, which were manually
  # # corrected in AutoCAD. Once we receive corrected upstream data, restore the merge
  # # operations from the three source files and change back to sync:push.
  # # TODO: Restore original operations once upstream DXF files are updated:
  # #   - Uncomment merge operations below
  # #   - Remove sync:pull and restore sync:push
  # #   - Remove Baugrenze intersection
  # - name: PV Modules
  #   sync: pull
  #   style: pvModules
  #   # operations:
  #   #   - type: merge
  #   #     layers:
  #   #       - PV Modules I Source
  #   #       - PV Modules II Source
  #   #       - PV Modules Süd Source
  #   #   - type: dissolve
  #   #   - type: intersection
  #   #     layers:
  #   #       - Baugrenze

  # - name: PV Modules Schraffur
  #   sync: push
  #   style: pvModulesLegend
  #   applyHatch:
  #     layers:
  #       - PV Modules

  # --------------------------------------------------------------------------
  # Lagerfläche (Storage Areas) from External DXF
  # --------------------------------------------------------------------------

  # Individual Lagerfläche sources (loaded separately, then merged)
  - name: Lagerfläche I Source
    dxfSource:
      file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20251021_Groß Plasten I - Am Spargelberg 9m_bereinigt.dxf"
      layer: "06 Lagerfläche"
      entityTypes:
        - HATCH

  - name: Lagerfläche II Source
    dxfSource:
      file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20251021_Groß Plasten II - Devener Weg_bereinigt.dxf"
      layer: "06 Lagerfläche"
      entityTypes:
        - HATCH

  - name: Lagerfläche Süd Source
    dxfSource:
      file: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/Grundlagen/Belegungskonzept/20250827_Klein Plasten Süd - Rockower Str.dxf"
      layer: "06 Lagerfläche"
      entityTypes:
        - HATCH

  # Combined Lagerfläche layer (all storage areas merged)
  - name: Lagerfläche
    sync: push
    style: lagerfläche
    operations:
      - type: dissolve
        layers:
          - Lagerfläche I Source
          - Lagerfläche II Source
          - Lagerfläche Süd Source

  - name: Lagerfläche Schraffur
    sync: push
    style: lagerflächeLegend
    applyHatch:
      layers:
        - Lagerfläche

  # ==========================================================================
  # SECTION 2: BUFFER CALCULATIONS - Baugrenze Exclusion Zones
  # ==========================================================================
  # These buffers create dead zones within AgriPV where Baugrenze cannot be placed.
  # AgriPV extends to these features, but Baugrenze must maintain buffer distances.

  # --------------------------------------------------------------------------
  # Wald Buffers: 10m for AgriPV exclusion, 30m for Baugrenze buffer zone
  # --------------------------------------------------------------------------

  # 10m buffer: AgriPV must stay this far from Wald
  - name: Wald 10m Buffer
    operations:
      - type: buffer
        layers:
          - Wald
        distance: 10
        joinStyle: round  # Use round joins to maintain true 10m distance at corners
        capStyle: round
        quadSegs: 32

  # 30m buffer: Used for Baugrenze calculation (creates 20m dead zone in AgriPV)
  - name: Waldabstand
    operations:
      - type: buffer
        layers:
          - Wald
        distance: 30
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # Biotope Buffers: 10m clearance (general rule) + 20m dead zone (stricter)
  # --------------------------------------------------------------------------
  # Planning rules:
  #   1. Biotope clearance: 10m buffer from biotope edges (general requirement)
  #   2. Dead zone rule: 20m minimum from Geltungsbereich to Baugrenze
  # Since 20m > 10m, we apply the 20m buffer to satisfy both requirements.

  # 10m buffer: Documents the general biotope clearance requirement
  # NOTE: Not used in calculations - kept for documentation only
  # The 20m buffer below is actually applied (satisfies both 10m and 20m rules)
  - name: Biotope 10m Buffer
    operations:
      - type: buffer
        layers:
          - Biotope
        distance: 10
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # 20m buffer: Applied to Baugrenze Exclusions
  # Satisfies both:
  #   - 10m biotope clearance requirement (20m > 10m)
  #   - 20m dead zone requirement (Geltungsbereich to Baugrenze distance)
  - name: Biotope 20m Buffer
    operations:
      - type: buffer
        layers:
          - Biotope
        distance: 20
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # Tree Line Buffer: 20m
  # --------------------------------------------------------------------------

  - name: Einzelbaumlinie Buffer
    operations:
      - type: buffer
        layers:
          - Einzelbaumlinie
        distance: 20
        joinStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # Road Edge Buffer: 20m
  # --------------------------------------------------------------------------

  - name: Straßenflurstückskante Buffer
    operations:
      - type: buffer
        layers:
          - Straßenflurstückskante
        distance: 20
        joinStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # FG Utility Line: 20m buffer (±40m total)
  # --------------------------------------------------------------------------

  - name: FG Line
    operations:
      - type: dissolve
        layers:
          - FG_Unterirdisch
          - FG_Oberirdisch

  - name: FG Buffer
    operations:
      - type: copy
        layers:
          - FG Line
      - type: dissolve
      - type: buffer
        distance: 20
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # Gas Lines: 10m buffers
  # --------------------------------------------------------------------------

  - name: Gastrasse
    sync: push
    operations:
      - type: copy
        layers:
          - Ontras_FG_buffer_2
          - Ontras_FG_buffer_4
      - type: cleanLine
        tolerance: 0.01              # Merge vertices closer than 1cm
        minSegmentLength: 0.5        # Remove segments shorter than 0.5m (fixes alternating rotation!)
        simplifyTolerance: 0.0       # Douglas-Peucker simplification (0 = disabled)

  - name: Ontras_FG_buffer_4 Buffer
    operations:
      - type: buffer
        layers:
          - Ontras_FG_buffer_4
        distance: 10
        joinStyle: round
        capStyle: round
        quadSegs: 32

  - name: Ontras_FG_buffer_2 Buffer
    operations:
      - type: buffer
        layers:
          - Ontras_FG_buffer_2
        distance: 10
        joinStyle: round
        capStyle: round
        quadSegs: 32

  - name: Gastrasse Buffer
    operations:
      - type: copy
        layers:
          - Ontras_FG_buffer_4 Buffer
          - Ontras_FG_buffer_2 Buffer
      - type: dissolve

  # --------------------------------------------------------------------------
  # Mittelspannungsleitung Buffer: 3m
  # --------------------------------------------------------------------------

  - name: Mittelspannungsleitung Buffer
    operations:
      - type: buffer
        layers:
          - Mittelspannungsleitung
        distance: 3
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # Building Buffer: 150m
  # --------------------------------------------------------------------------

  - name: Gebäude Buffer
    operations:
      - type: buffer
        layers:
          - Gebäude 150m Abstand
        distance: 150
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # --------------------------------------------------------------------------
  # Böschung Buffer: 20m
  # --------------------------------------------------------------------------

  - name: Böschung Buffer
    operations:
      - type: buffer
        layers:
          - Böschung
        distance: 20
        joinStyle: round
        capStyle: round
        quadSegs: 32

  # ==========================================================================
  # SECTION 3: EXCLUSION ZONE AGGREGATION
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Hard Exclusions: Areas where AgriPV can NEVER be
  # Includes Wald + 10m gap (Biotope handled separately in AgriPV Base)
  # Note: Moor is now a soft exclusion (allows AgriPV but not Baugrenze)
  # --------------------------------------------------------------------------

  - name: Hard Exclusions
    operations:
      - type: copy
        layers:
          - Wald 10m Buffer
          # - Exclude Baufeld
          - Exclude Geltungsbereich
      - type: dissolve

  # --------------------------------------------------------------------------
  # Baugrenze Exclusions: Buffer zones that Baugrenze must avoid
  # Note: Waldabstand NOT included - the 10m gap + 20m inset = 30m from forest already
  # Note: Moor added as soft exclusion (0m buffer - Baugrenze stops at edge)
  # Note: Biotope 20m Buffer ensures:
  #       - 10m biotope clearance (planning requirement)
  #       - 20m dead zone from Geltungsbereich to Baugrenze (stricter rule)
  # Note: Böschung 20m Buffer ensures 20m clearance from slopes/embankments
  # --------------------------------------------------------------------------

  - name: Baugrenze Exclusions
    operations:
      - type: copy
        layers:
          - FG Buffer
          - Gastrasse Buffer
          - Mittelspannungsleitung Buffer
          - Gebäude Buffer
          - Einzelbaumlinie Buffer
          - Straßenflurstückskante Buffer
          - Böschung Buffer
          - Moor
          - Biotope 20m Buffer
      - type: dissolve

  # ==========================================================================
  # SECTION 4: GELTUNGSBEREICH BASE - Calculated from parcels
  # ==========================================================================
  # These are temporary "Base" versions used for filtering/intersection.
  # The FINAL Geltungsbereich follows AgriPV outline (calculated later).

  # --------------------------------------------------------------------------
  # Geltungsbereich NW Base: Parcels 1,2,4,6,7,14 (Flur 1, Groß Plasten)
  # --------------------------------------------------------------------------

  - name: Geltungsbereich NW Base
    style: geltungsbereich
    operations:
      - type: copy
        layers:
          - name: Parcel
            values:
              - "1"
              - "2"
              - "4"
              - "6"
              - "7"
              - "14"
      - type: filterByIntersection
        layers:
          - name: Flur Input
            values:
              - "Flur 1"
          - name: Gemarkung Input
            values:
              - "Groß Plasten"
          - name: Gemeinde Input
            values:
              - "Groß Plasten"
      - type: dissolve

  # --------------------------------------------------------------------------
  # Geltungsbereich NO Base: Parcels 24/8, 24/9 (Flur 1, Groß Plasten)
  # --------------------------------------------------------------------------

  - name: Geltungsbereich NO Base
    style: geltungsbereich
    close: true
    operations:
      - type: copy
        layers:
          - name: Parcel
            values:
              - "24/8"
              - "24/9"
      - type: filterByIntersection
        layers:
          - name: Flur Input
            values:
              - "Flur 1"
          - name: Gemarkung Input
            values:
              - "Groß Plasten"
          - name: Gemeinde Input
            values:
              - "Groß Plasten"
      - type: dissolve

  # --------------------------------------------------------------------------
  # Geltungsbereich S Base: Parcel 41/1 (Flur 2, Klein Plasten)
  # --------------------------------------------------------------------------

  - name: Geltungsbereich S Base
    style: geltungsbereich
    close: true
    operations:
      - type: copy
        layers:
          - name: Parcel
            values:
              - "41/1"
      - type: filterByIntersection
        layers:
          - name: Flur Input
            values:
              - "Flur 2"
          - name: Gemarkung Input
            values:
              - "Klein Plasten"
          - name: Gemeinde Input
            values:
              - "Groß Plasten"
      - type: dissolve

  # ==========================================================================
  # SECTION 4.5: WEGE FILTERING
  # ==========================================================================
  # Filter Wege to only parts within each planning region

  - name: Wege Filtered NW
    operations:
      - type: copy
        layers:
          - Wege Input
      - type: filterByIntersection
        layers:
          - Geltungsbereich NW Base

  - name: Wege Filtered NO
    operations:
      - type: copy
        layers:
          - Wege Input
      - type: filterByIntersection
        layers:
          - Geltungsbereich NO Base

  # South region does not include Wege
  # - name: Wege Filtered S
  #   operations:
  #     - type: copy
  #       layers:
  #         - Wege Input
  #     - type: filterByIntersection
  #       layers:
  #         - Geltungsbereich S Base

  # Combined Wege from all regions (for final output layer)
  - name: Wege Filtered
    operations:
      - type: dissolve
        layers:
          - Wege Filtered NW
          - Wege Filtered NO
          # - Wege Filtered S  # South excluded

  # ==========================================================================
  # SECTION 5: AGRIPV BASE CALCULATION
  # ==========================================================================
  # AgriPV Base = (Parcels - Hard Exclusions) → -20m mitre → +20m mitre
  # The -20/+20 buffer trick ensures sharp corners while maintaining geometric character.
  # This base layer is then intersected with land use constraints (Acker/Nutzungsartengrenze)
  # at the Geltungsbereich level to create the final legal planning boundaries.

  # --------------------------------------------------------------------------
  # AgriPV Base: Initial solar planning zone (before 20m constraint)
  # --------------------------------------------------------------------------

  - name: AgriPV Base Unclipped
    operations:
      # Start with all parcels
      - type: copy
        layers:
          - Geltungsbereich NW Base
          - Geltungsbereich NO Base
          - Geltungsbereich S Base
      # Remove hard exclusions (Wald+10m, manual exclusions)
      - type: difference
        layers:
          - Hard Exclusions
        reverseDifference: false
      # Buffer trick: -20m (mitre) then +20m (mitre) to shape AgriPV
      # This ensures Baugrenze can reach all areas with sharp corners
      - type: buffer
        distance: -20
        joinStyle: mitre
        mitreLimit: 2.7
        quadSegs: 32
      - type: buffer
        distance: 20
        joinStyle: mitre
        mitreLimit: 2.7
        quadSegs: 32
      # Clean up small artifacts
      - type: filterGeometry
        minArea: 200
        geometryTypes:
          - Polygon

  # Final AgriPV Base (no land use clipping - that happens at Geltungsbereich level)
  - name: AgriPV Base
    operations:
      - type: copy
        layers:
          - AgriPV Base Unclipped
      # Clean up and add manual inclusions
      - type: removeDegenerateSpikes
        tolerance: 0.01
        simplifyTolerance: 0.05
        minSpikeLength: 0.1
      - type: removeProtrusions
        bufferDistance: 0.5
        minProtrusionLength: 1.0
      - type: removeSliversErosion
        erosionDistance: 0.2
      - type: repair
        minArea: 20
        removeEmptyGeometries: true
        removeFailures: true
      # Add manual inclusion areas
      - type: dissolve
        layers:
          - Include AgriPV
      # Subtract biotope centers (but not the 10m buffer ring)
      - type: difference
        layers:
          - Biotope
        reverseDifference: false

  # ==========================================================================
  # SECTION 6: FINAL AGRIPV - Combined from all Geltungsbereich regions
  # ==========================================================================
  # AgriPV is now simply the combined Geltungsbereich areas (NW + NO + S)
  # This ensures AgriPV matches the actual legal planning boundaries
  
  - name: AgriPV
    close: true
    sync: push
    viewports:
      - name: WorkView
        style: agripv
    operations:
      - type: dissolve
        layers:
          - Geltungsbereich NW
          - Geltungsbereich NO
          - Geltungsbereich S
      # Subtract Zuwegung (access roads) from AgriPV
      - type: difference
        layers:
          - Zuwegung
        reverseDifference: false

  # ==========================================================================
  # SECTION 7: FINAL GELTUNGSBEREICH - AgriPV with land use constraints + Wege
  # ==========================================================================
  # Geltungsbereich logic by region:
  # - NW: ((AgriPV Base ∪ Acker) ∩ Parcels ∪ Include GB) ∩ Parcels + Wege
  #       → Expands into Acker, then adds manual inclusions (overrides land use)
  # - NO: ((AgriPV Base ∪ Nutzungsartengrenze) ∩ Nutzung ∩ Parcels ∪ Include GB) ∩ Parcels + Wege
  #       → Expands into Nutzungsartengrenze, then adds manual inclusions (overrides land use)
  # - S:  ((AgriPV Base ∩ Acker_S) ∩ Parcels ∪ Include GB) ∩ Parcels
  #       → Constrains to Acker_S, then adds manual inclusions (overrides land use)
  # 
  # Key: Include Geltungsbereich ALWAYS gets added, overriding land use constraints,
  #      but the final result is ALWAYS constrained to parcel boundaries.
  # Finally, NW and NO regions merge with Wege (paths/roads) to include access routes.

  - name: Geltungsbereich NW Before Wege
    operations:
      - type: dissolve
        layers:
          - AgriPV Base
          - Acker
      # Constrain to parcel boundaries
      - type: intersection
        layers:
          - Geltungsbereich NW Base
      # Add manual inclusions (overrides land use constraints, but respects parcels)
      - type: dissolve
        layers:
          - Include Geltungsbereich
      # Ensure result stays within parcels
      - type: intersection
        layers:
          - Geltungsbereich NW Base
      # Remove interior rings (biotope center holes) - Geltungsbereich includes biotopes
      - type: removeInteriorRings
      # Stage 1: Remove degenerate spikes (zero-width, edge goes out and back on same path)
      - type: removeDegenerateSpikes
        tolerance: 0.01              # Merge vertices closer than 1cm
        simplifyTolerance: 0.05      # Simplify with 5cm tolerance
        minSpikeLength: 0.1          # Remove spikes thinner than 10cm
      # Stage 2: Remove thin protrusions
      - type: removeProtrusions
        bufferDistance: 0.5
        minProtrusionLength: 1.0
      # Stage 3: Remove slivers (thin features < 0.4m wide)
      - type: removeSliversErosion
        erosionDistance: 0.2
      # Stage 4: Final repair and cleanup
      - type: repair
        minArea: 20
        removeEmptyGeometries: true
        removeFailures: true

  - name: Geltungsbereich NW
    sync: push
    style: geltungsbereich
    operations:
      - type: dissolve
        layers:
          - Geltungsbereich NW Before Wege
          - Wege Filtered NW
      # Subtract manual exclusions after merging with Wege
      - type: difference
        layers:
          - Exclude Geltungsbereich
        reverseDifference: false
      # Final cleanup after merging with Wege
      - type: removeDegenerateSpikes
        tolerance: 0.01
        simplifyTolerance: 0.05
        minSpikeLength: 0.1
      - type: repair
        minArea: 20
        removeEmptyGeometries: true
        removeFailures: true

  - name: Geltungsbereich NO Before Wege
    operations:
      - type: dissolve
        layers:
          - AgriPV Base
          - Nutzungsartengrenze
      # Constrain to Nutzungsartengrenze boundaries first
      - type: intersection
        layers:
          - Nutzungsartengrenze
      # Then constrain to parcel boundaries
      - type: intersection
        layers:
          - Geltungsbereich NO Base
      # Add manual inclusions (overrides land use constraints, but respects parcels)
      - type: dissolve
        layers:
          - Include Geltungsbereich
      # Ensure result stays within parcels
      - type: intersection
        layers:
          - Geltungsbereich NO Base
      # Remove interior rings (biotope center holes) - Geltungsbereich includes biotopes
      - type: removeInteriorRings
      # Stage 1: Remove degenerate spikes (zero-width, edge goes out and back on same path)
      - type: removeDegenerateSpikes
        tolerance: 0.01              # Merge vertices closer than 1cm
        simplifyTolerance: 0.05      # Simplify with 5cm tolerance
        minSpikeLength: 0.1          # Remove spikes thinner than 10cm
      # Stage 2: Remove thin protrusions
      - type: removeProtrusions
        bufferDistance: 0.5
        minProtrusionLength: 1.0
      # Stage 3: Remove slivers (thin features < 0.4m wide)
      - type: removeSliversErosion
        erosionDistance: 0.2
      # Stage 4: Final repair and cleanup
      - type: repair
        minArea: 20
        removeEmptyGeometries: true
        removeFailures: true

  - name: Geltungsbereich NO
    sync: push
    style: geltungsbereich
    operations:
      - type: dissolve
        layers:
          - Geltungsbereich NO Before Wege
          - Wege Filtered NO
      # Subtract manual exclusions after merging with Wege
      - type: difference
        layers:
          - Exclude Geltungsbereich
        reverseDifference: false
      # Final cleanup after merging with Wege
      - type: removeDegenerateSpikes
        tolerance: 0.01
        simplifyTolerance: 0.05
        minSpikeLength: 0.1
      - type: repair
        minArea: 20
        removeEmptyGeometries: true
        removeFailures: true

  # South region does not include Wege - no intermediate "Before Wege" layer needed
  - name: Geltungsbereich S
    sync: push
    style: geltungsbereich
    operations:
      - type: dissolve
        layers:
          - AgriPV Base
      # Constrain to Acker_S areas (intersection, not union)
      - type: intersection
        layers:
          - Acker_S
      # Constrain to parcel boundaries
      - type: intersection
        layers:
          - Geltungsbereich S Base
      # Add manual inclusions (overrides land use constraints, but respects parcels)
      - type: dissolve
        layers:
          - Include Geltungsbereich
      # Ensure result stays within parcels
      - type: intersection
        layers:
          - Geltungsbereich S Base
      # Remove interior rings (biotope center holes) - Geltungsbereich includes biotopes
      - type: removeInteriorRings
      # Stage 1: Remove degenerate spikes (zero-width, edge goes out and back on same path)
      - type: removeDegenerateSpikes
        tolerance: 0.01              # Merge vertices closer than 1cm
        simplifyTolerance: 0.05      # Simplify with 5cm tolerance
        minSpikeLength: 0.1          # Remove spikes thinner than 10cm
      # Stage 2: Remove thin protrusions
      - type: removeProtrusions
        bufferDistance: 0.5
        minProtrusionLength: 1.0
      # Stage 3: Remove slivers (thin features < 0.4m wide)
      - type: removeSliversErosion
        erosionDistance: 0.2
      # Stage 4: Final repair and cleanup
      - type: repair
        minArea: 20
        removeEmptyGeometries: true
        removeFailures: true

  # ==========================================================================
  # SECTION 6.5: BAUGRENZE CALCULATION
  # ==========================================================================
  # Baugrenze = (Geltungsbereich Before Wege layers) -20m, minus exclusions
  # This ensures 20m distance from Geltungsbereich boundary to Baugrenze

  # Combined Geltungsbereich Before Wege (all regions for Baugrenze calculation)
  - name: Geltungsbereich All Regions Before Wege
    operations:
      - type: dissolve
        layers:
          - Geltungsbereich NW Before Wege
          - Geltungsbereich NO Before Wege
          - Geltungsbereich S

  - name: Baugrenze
    sync: push
    style: baugrenze
    linetypeScale: 0.5
    linetypeGeneration: true
    close: true
    operations:
      # Start with -20m inset from combined Geltungsbereich areas
      - type: buffer
        layers:
          - Geltungsbereich All Regions Before Wege
        distance: -20
        joinStyle: mitre
        mitreLimit: 1.0  # Sharp corners where possible, bevels to maintain ≥20m minimum
        quadSegs: 32
      # Subtract ALL Baugrenze exclusion zones (utilities, roads, trees, buildings, Moor)
      - type: difference
        layers:
          - Baugrenze Exclusions
          - Exclude Baugrenze
        reverseDifference: false

  - name: Baugrenze 2
    sync: push
    style: baugrenze_2
    close: true
    operations:
      - type: buffer
        layers:
          - Baugrenze
        distance: -0.4
        joinStyle: mitre

  # --------------------------------------------------------------------------
  # Geltungsbereich +2m Styling Variants
  # --------------------------------------------------------------------------

  - name: Geltungsbereich NW 2
    sync: push
    linetypeScale: 1
    style: geltungsbereich_2
    operations:
      - type: buffer
        layers:
          - Geltungsbereich NW
        distance: 2
        joinStyle: mitre

  - name: Geltungsbereich NO 2
    sync: push
    linetypeScale: 1
    style: geltungsbereich_2
    operations:
      - type: buffer
        layers:
          - Geltungsbereich NO
        distance: 2
        joinStyle: mitre

  - name: Geltungsbereich S 2
    sync: push
    linetypeScale: 1
    style: geltungsbereich_2
    operations:
      - type: buffer
        layers:
          - Geltungsbereich S
        distance: 2
        joinStyle: mitre

  # ==========================================================================
  # SECTION 7.6: GFL PATH LAYERS - Utility Corridor Boundary Lines
  # ==========================================================================
  # These layers create visual boundary lines inside utility buffer zones
  # for placement of GFL Symbol blocks via path arrays.

  - name: FG Buffer Path
    sync: push
    style: gflPath
    operations:
      - type: copy
        layers:
          - FG Buffer
      - type: buffer
        distance: -0.7
        joinStyle: mitre
      - type: intersection
        layers:
          - Geltungsbereich NW
          - Geltungsbereich NO
          - Geltungsbereich S

  - name: Gastrasse Buffer Path
    sync: push
    style: gflPath
    operations:
      - type: copy
        layers:
          - Gastrasse Buffer
      - type: buffer
        distance: -0.7
        joinStyle: mitre
      - type: intersection
        layers:
          - Geltungsbereich NW
          - Geltungsbereich NO
          - Geltungsbereich S

  - name: Mittelspannungsleitung Buffer Path
    sync: push
    style: gfl1
    linetypeScale: 0.1
    linetypeGeneration: true
    operations:
      - type: copy
        layers:
          - Mittelspannungsleitung Buffer
      - type: buffer
        distance: -0.7
        joinStyle: mitre
      - type: intersection
        layers:
          - Geltungsbereich NW
          - Geltungsbereich NO
          - Geltungsbereich S

  # Combined GFL buffer path (all utility buffers merged)
  - name: All GFL Buffer Path
    sync: push
    style: gflPath
    operations:
      - type: dissolve
        layers:
          - FG Buffer Path
          - Gastrasse Buffer Path

  # ==========================================================================
  # SECTION 7.5: FINAL WEGE OUTPUT
  # ==========================================================================
  # Final Wege layer showing paths outside AgriPV area

  - name: Wege
    style: verkehrsfläche
    operations:
      - type: copy
        layers:
          - Wege Filtered
      - type: difference
        layers:
          - AgriPV
        reverseDifference: false

  - name: Zuwegung Schraffur
    sync: push
    style: verkehrsfläche
    applyHatch:
      layers:
        - Zuwegung

  # ==========================================================================
  # SECTION 8: HATCHING LAYERS
  # ==========================================================================

  - name: Wald Schraffur
    sync: push
    style: wald
    viewports:
      - name: WorkView
        style: waldWorkView
    applyHatch:
      layers:
        - Wald

  - name: AgriPV Schraffur Solid
    sync: push
    style: agripvSolid
    applyHatch:
      layers:
        - AgriPV

  - name: AgriPV Schraffur Lines
    sync: push
    style: agripvLines
    applyHatch:
      layers:
        - AgriPV

  - name: Gebäude Schraffur
    sync: push
    style: gebäude
    applyHatch:
      layers:
        - Gebäude

  - name: Geltungsbereich NW Schraffur
    sync: push
    style: geltungsbereichHatch
    applyHatch:
      layers:
        - Geltungsbereich NW

  - name: Geltungsbereich NO Schraffur
    sync: push
    style: geltungsbereichHatch
    applyHatch:
      layers:
        - Geltungsbereich NO

  - name: Geltungsbereich S Schraffur
    sync: push
    style: geltungsbereichHatch
    applyHatch:
      layers:
        - Geltungsbereich S

  # ==========================================================================
  # SECTION 9: INFRASTRUCTURE LAYERS
  # ==========================================================================

  # - name: Blendschutzzaun
  #   shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/blendschutzzaun.shp"
  #   style: blendschutzzaun
  #   sync: push

  - name: EinAusfahrt Line
    sync: push
    style:
      layer:
        color: "magenta"
        lineweight: 50
        plot: false
    type: "line"
    shapeFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/input/einausfahrt_line.shp"

  # ==========================================================================
  # SECTION 10: BIOTOPE OUTPUT
  # ==========================================================================

  # Base biotope within Geltungsbereich
  - name: Biotope Innerhalb Geltungsbereich
    operations:
      - type: copy
        layers:
          - Geschütze Biotope
      - type: intersection
        layers:
          - Geltungsbereich NW
          - Geltungsbereich NO
          - Geltungsbereich S

  # Inner biotope area (inset by 3m from boundary)
  - name: Geschütze Biotope Innenfläche
    sync: push
    viewports:
      - name: WorkView
        style: biotopWorkView
    operations:
      - type: buffer
        layers:
          - Biotope Innerhalb Geltungsbereich
        distance: -3
        joinStyle: round

  # Solid hatching for inner biotope area
  - name: Geschütze Biotope Innenfläche Schraffur
    sync: push
    style: grünfläche
    applyHatch:
      layers:
        - Geschütze Biotope Innenfläche

  # Outer ring (3m wide border inside the biotope boundary)
  - name: Geschütze Biotope Umgrenzung
    sync: push
    operations:
      - type: copy
        layers:
          - Biotope Innerhalb Geltungsbereich
      - type: difference
        layers:
          - Geschütze Biotope Innenfläche
        reverseDifference: false

  # T-symbol hatching for the outer ring
  - name: Geschütze Biotope Umgrenzung Schraffur
    sync: push
    style: schutzflächeumgrenzung
    applyHatch:
      layers:
        - Geschütze Biotope Umgrenzung

  # Biotope outline with special linetype
  - name: Geschütze Biotope 2
    sync: push
    linetypeGeneration: true
    style: gesGeschuetzesBiotop
    operations:
      - type: buffer
        layers:
          - Geschütze Biotope
        distance: 0.5
        joinStyle: mitre

  # ==========================================================================
  # SECTION 11: AREA REPORTS - Statistics for each Geltungsbereich
  # ==========================================================================
  # These layers generate area reports broken down by Geltungsbereich region.
  # Reports are output to: projects/Plasten/generated/reports/
  # Each report contains area calculations in m² rounded to 0 decimal places.

  # --------------------------------------------------------------------------
  # Geltungsbereich NW Reports
  # --------------------------------------------------------------------------

  - name: Geltungsbereich NW Report
    operations:
      - type: copy
        layers:
          - Parcel
      - type: calculate
        calculations:
          - type: area
            as: parcel_area
            decimalPlaces: 0
      - type: intersection
        layers:
          - Geltungsbereich NW
      - type: filterGeometry
        minArea: 10
        geometryTypes:
          - polygon
      - type: calculate
        calculations:
          - type: area
            as: intersection_area
            decimalPlaces: 0
          - type: coverage_status
            areaTolerance: 10
            totalAreaColumn: parcel_area
            intersectionAreaColumn: intersection_area
            as: status
            completeLabel: "vollständig"
            partialLabel: "teilweise"
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/geltungsbereich_nw_report.json"
        sortBy: label
        featureColumns:
          - label
          - parcel_area
          - intersection_area
          - status
        calculate:
          - area
        decimalPlaces:
          area: 0
          parcel_area: 0
          intersection_area: 0
        metadata:
          area_tolerance_m2: 10
          coverage_status_logic: "vollständig if |parcel_area - intersection_area| <= 10 m²"

  - name: Baugrenze NW Report
    operations:
      - type: copy
        layers:
          - Baugrenze
      - type: intersection
        layers:
          - Geltungsbereich NW Base
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/baugrenze_nw_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  - name: AgriPV Dead Zone NW Report
    operations:
      - type: copy
        layers:
          - AgriPV
      - type: intersection
        layers:
          - Geltungsbereich NW Base
      - type: difference
        reverseDifference: false
        layers:
          - Baugrenze
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/agripv_dead_zone_nw_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  - name: Biotope NW Report
    operations:
      - type: copy
        layers:
          - Geschütze Biotope
      - type: intersection
        layers:
          - Geltungsbereich NW
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/biotope_nw_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  # --------------------------------------------------------------------------
  # Geltungsbereich NO Reports
  # --------------------------------------------------------------------------

  - name: Geltungsbereich NO Report
    operations:
      - type: copy
        layers:
          - Parcel
      - type: calculate
        calculations:
          - type: area
            as: parcel_area
            decimalPlaces: 0
      - type: intersection
        layers:
          - Geltungsbereich NO
      - type: filterGeometry
        minArea: 10
        geometryTypes:
          - polygon
      - type: calculate
        calculations:
          - type: area
            as: intersection_area
            decimalPlaces: 0
          - type: coverage_status
            areaTolerance: 10
            totalAreaColumn: parcel_area
            intersectionAreaColumn: intersection_area
            as: status
            completeLabel: "vollständig"
            partialLabel: "teilweise"
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/geltungsbereich_no_report.json"
        sortBy: label
        featureColumns:
          - label
          - parcel_area
          - intersection_area
          - status
        calculate:
          - area
        decimalPlaces:
          area: 0
          parcel_area: 0
          intersection_area: 0
        metadata:
          area_tolerance_m2: 10
          coverage_status_logic: "vollständig if |parcel_area - intersection_area| <= 10 m²"

  - name: Baugrenze NO Report
    operations:
      - type: copy
        layers:
          - Baugrenze
      - type: intersection
        layers:
          - Geltungsbereich NO Base
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/baugrenze_no_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  - name: AgriPV Dead Zone NO Report
    operations:
      - type: copy
        layers:
          - AgriPV
      - type: intersection
        layers:
          - Geltungsbereich NO Base
      - type: difference
        reverseDifference: false
        layers:
          - Baugrenze
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/agripv_dead_zone_no_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  - name: Biotope NO Report
    operations:
      - type: copy
        layers:
          - Geschütze Biotope
      - type: intersection
        layers:
          - Geltungsbereich NO
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/biotope_no_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  # --------------------------------------------------------------------------
  # Geltungsbereich S Reports
  # --------------------------------------------------------------------------

  - name: Geltungsbereich S Report
    operations:
      - type: copy
        layers:
          - Parcel
      - type: calculate
        calculations:
          - type: area
            as: parcel_area
            decimalPlaces: 0
      - type: intersection
        layers:
          - Geltungsbereich S
      - type: filterGeometry
        minArea: 10
        geometryTypes:
          - polygon
      - type: calculate
        calculations:
          - type: area
            as: intersection_area
            decimalPlaces: 0
          - type: coverage_status
            areaTolerance: 10
            totalAreaColumn: parcel_area
            intersectionAreaColumn: intersection_area
            as: status
            completeLabel: "vollständig"
            partialLabel: "teilweise"
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/geltungsbereich_s_report.json"
        sortBy: label
        featureColumns:
          - label
          - parcel_area
          - intersection_area
          - status
        calculate:
          - area
        decimalPlaces:
          area: 0
          parcel_area: 0
          intersection_area: 0
        metadata:
          area_tolerance_m2: 10
          coverage_status_logic: "vollständig if |parcel_area - intersection_area| <= 10 m²"

  - name: Baugrenze S Report
    operations:
      - type: copy
        layers:
          - Baugrenze
      - type: intersection
        layers:
          - Geltungsbereich S Base
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/baugrenze_s_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  - name: AgriPV Dead Zone S Report
    operations:
      - type: copy
        layers:
          - AgriPV
      - type: intersection
        layers:
          - Geltungsbereich S Base
      - type: difference
        reverseDifference: false
        layers:
          - Baugrenze
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/agripv_dead_zone_s_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

  - name: Biotope S Report
    operations:
      - type: copy
        layers:
          - Geschütze Biotope
      - type: intersection
        layers:
          - Geltungsbereich S
      - type: report
        outputFile: "Öffentlich Planungsbüro Schulz/Projekte/23-24 Maxsolar - Plasten/GIS/reports/biotope_s_report.json"
        calculate:
          - area
        decimalPlaces:
          area: 0

